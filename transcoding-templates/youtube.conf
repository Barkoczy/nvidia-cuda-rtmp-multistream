#!/bin/bash

# Tento súbor by mal byť umiestnený v /usr/local/nginx/conf/transcoding-templates/youtube.sh

# Získanie vstupných parametrov z NGINX RTMP
name="$1"
youtube_key="$2" # YouTube stream kľúč

# Konfiguračné premenné s predvolenými hodnotami
YOUTUBE_URL="${YOUTUBE_URL:-rtmp://a.rtmp.youtube.com/live2}"
YOUTUBE_BITRATE="${YOUTUBE_BITRATE:-40000k}"
YOUTUBE_FRAMERATE="${YOUTUBE_FRAMERATE:-60}"
YOUTUBE_GOP_SIZE="${YOUTUBE_GOP_SIZE:-120}"
YOUTUBE_PRESET="${YOUTUBE_PRESET:-fast}"

# Vytvorenie log súboru s časovou značkou
LOG_FILE="/var/log/ffmpeg/youtube_$(date +%Y%m%d_%H%M%S).log"

echo "Začínam transkódovanie streamu pre YouTube..." | tee -a $LOG_FILE
echo "Stream name: $name, YouTube key: ${youtube_key:0:5}..." | tee -a $LOG_FILE
echo "Nastavenia: bitrate=${YOUTUBE_BITRATE}, framerate=${YOUTUBE_FRAMERATE}, GOP=${YOUTUBE_GOP_SIZE}" | tee -a $LOG_FILE

# Skúsime najprv hevc_nvenc, ak zlyhá, prejdeme na h264_nvenc
if ffmpeg -y -hwaccel cuda -hwaccel_device 0 -i rtmp://localhost:1935/live/$name \
  -c:v hevc_nvenc -preset ${YOUTUBE_PRESET} -profile:v main \
  -b:v ${YOUTUBE_BITRATE} -maxrate ${YOUTUBE_BITRATE} -bufsize ${YOUTUBE_BITRATE} \
  -g ${YOUTUBE_GOP_SIZE} -keyint_min ${YOUTUBE_GOP_SIZE} \
  -r ${YOUTUBE_FRAMERATE} \
  -c:a aac -b:a 128k \
  -f flv ${YOUTUBE_URL}/${youtube_key} 2> $LOG_FILE; then
    echo "YouTube stream úspešne odoslaný pomocou hevc_nvenc" | tee -a $LOG_FILE
else
    echo "hevc_nvenc zlyhalo, skúšam h264_nvenc..." | tee -a $LOG_FILE
    
    # Ak hevc_nvenc zlyhá, skúsime h264_nvenc
    if ffmpeg -y -hwaccel cuda -hwaccel_device 0 -i rtmp://localhost:1935/live/$name \
      -c:v h264_nvenc -preset ${YOUTUBE_PRESET} -profile:v high \
      -b:v ${YOUTUBE_BITRATE} -maxrate ${YOUTUBE_BITRATE} -bufsize ${YOUTUBE_BITRATE} \
      -g ${YOUTUBE_GOP_SIZE} -keyint_min ${YOUTUBE_GOP_SIZE} \
      -r ${YOUTUBE_FRAMERATE} \
      -c:a aac -b:a 128k \
      -f flv ${YOUTUBE_URL}/${youtube_key} 2>> $LOG_FILE; then
        echo "YouTube stream úspešne odoslaný pomocou h264_nvenc" | tee -a $LOG_FILE
    else
        # Ak ani h264_nvenc nefunguje, skúsime CPU kódovanie ako poslednú možnosť
        echo "h264_nvenc zlyhalo, skúšam CPU encoding (libx264)..." | tee -a $LOG_FILE
        
        ffmpeg -y -i rtmp://localhost:1935/live/$name \
          -c:v libx264 -preset veryfast -profile:v high \
          -b:v ${YOUTUBE_BITRATE} -maxrate ${YOUTUBE_BITRATE} -bufsize ${YOUTUBE_BITRATE} \
          -g ${YOUTUBE_GOP_SIZE} -keyint_min ${YOUTUBE_GOP_SIZE} \
          -r ${YOUTUBE_FRAMERATE} \
          -c:a aac -b:a 128k \
          -f flv ${YOUTUBE_URL}/${youtube_key} 2>> $LOG_FILE
          
        echo "YouTube stream dokončený pomocou CPU (libx264)" | tee -a $LOG_FILE
    fi
fi